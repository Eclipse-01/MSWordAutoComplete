name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š1.0.0ï¼‰'
        required: false
        default: '1.0.0'

jobs:
  build-office-addin:
    name: æž„å»º Office åŠ è½½é¡¹
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æž„å»ºé¡¹ç›®
        run: npm run build
      
      - name: æ‰“åŒ… Office åŠ è½½é¡¹
        run: |
          mkdir -p release
          cd dist
          zip -r ../release/MSWordAutoComplete-Office-Addin-${{ github.ref_name || inputs.version }}.zip .
          cd ..
          cp manifest.xml release/
          cp README.md release/
          cp DISTRIBUTION.md release/
          cp USAGE.md release/
      
      - name: ç”Ÿæˆå®‰è£…è„šæœ¬
        run: node scripts/create-installers.js
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: office-addin
          path: release/

  build-electron:
    name: æž„å»º Electron åº”ç”¨ - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win
            arch: x64
          - os: macos-latest
            platform: mac
            arch: universal
          - os: ubuntu-latest
            platform: linux
            arch: x64
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æž„å»º Web èµ„æº
        run: npm run build
      
      - name: æž„å»º Electron åº”ç”¨ (Windows)
        if: matrix.platform == 'win'
        run: npm run electron:build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: æž„å»º Electron åº”ç”¨ (Mac)
        if: matrix.platform == 'mac'
        run: npm run electron:build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: æž„å»º Electron åº”ç”¨ (Linux)
        if: matrix.platform == 'linux'
        run: npm run electron:build:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: electron-${{ matrix.platform }}
          path: |
            release/*.exe
            release/*.dmg
            release/*.AppImage
            release/*.zip
          if-no-files-found: ignore

  create-release:
    name: åˆ›å»º Release
    needs: [build-office-addin, build-electron]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.zip" -o -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" -o -name "*.xml" -o -name "*.md" -o -name "*.ps1" -o -name "*.sh" \) -exec cp {} release-files/ \;
          ls -lh release-files/
      
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        run: |
          cat > release-notes.md << 'EOF'
          # Word æ™ºèƒ½è¡¥å…¨ ${{ github.ref_name }}
          
          ## ðŸŽ‰ æ–°åŠŸèƒ½
          
          - âœ… AI é©±åŠ¨çš„è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½
          - âœ… å†…è”èŠå¤©å’Œä¾§è¾¹èŠå¤©
          - âœ… æ”¯æŒ GitHub Copilotã€OpenAI å’Œè‡ªå®šä¹‰ API
          - âœ… æä¾› Office åŠ è½½é¡¹å’Œ Electron æ¡Œé¢åº”ç”¨ä¸¤ç§æ–¹å¼
          
          ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          
          ### Office åŠ è½½é¡¹ï¼ˆæŽ¨èï¼‰
          
          ä¸‹è½½ `MSWordAutoComplete-Office-Addin-*.zip`ï¼Œè§£åŽ‹åŽï¼š
          
          **Windows**ï¼šè¿è¡Œ `install-windows.ps1`  
          **Mac**ï¼šè¿è¡Œ `./install-mac.sh`
          
          è¯¦ç»†å®‰è£…æ­¥éª¤è¯·å‚è€ƒ [DISTRIBUTION.md](https://github.com/Eclipse-01/MSWordAutoComplete/blob/main/DISTRIBUTION.md)
          
          ### Electron æ¡Œé¢åº”ç”¨
          
          - **Windows**ï¼šä¸‹è½½ `Wordæ™ºèƒ½è¡¥å…¨-Setup-*.exe`
          - **Mac**ï¼šä¸‹è½½ `Wordæ™ºèƒ½è¡¥å…¨-*.dmg`
          - **Linux**ï¼šä¸‹è½½ `Wordæ™ºèƒ½è¡¥å…¨-*.AppImage`
          
          ## ðŸ“š æ–‡æ¡£
          
          - [å¿«é€Ÿå¼€å§‹æŒ‡å—](https://github.com/Eclipse-01/MSWordAutoComplete/blob/main/QUICKSTART.md)
          - [ä½¿ç”¨æ‰‹å†Œ](https://github.com/Eclipse-01/MSWordAutoComplete/blob/main/USAGE.md)
          - [Copilot é›†æˆè¯´æ˜Ž](https://github.com/Eclipse-01/MSWordAutoComplete/blob/main/COPILOT_INTEGRATION.md)
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          
          - æœ¬é¡¹ç›®æ˜¯ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œä¸Ž Microsoft å®˜æ–¹æ— å…³
          - éœ€è¦è‡ªå·±çš„ API å¯†é’¥ï¼ˆOpenAIã€GitHub Copilot æˆ–è‡ªå®šä¹‰ï¼‰
          - GitHub Copilot åŠŸèƒ½éœ€è¦åœ¨ Electron ç‰ˆæœ¬ä¸­ä½¿ç”¨
          
          ## ðŸ”’ å®‰å…¨
          
          è¯·æŸ¥çœ‹ [SECURITY.md](https://github.com/Eclipse-01/MSWordAutoComplete/blob/main/SECURITY.md) äº†è§£å®‰å…¨æ³¨æ„äº‹é¡¹ã€‚
          
          ---
          
          **å®Œæ•´å˜æ›´æ—¥å¿—**è¯·æŸ¥çœ‹æäº¤åŽ†å²ã€‚
          EOF
      
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-build:
    name: æµ‹è¯•æž„å»ºï¼ˆéž Releaseï¼‰
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref, 'refs/tags/')"
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: ä»£ç æ£€æŸ¥
        run: npm run lint || true
      
      - name: æž„å»ºé¡¹ç›®
        run: npm run build
      
      - name: éªŒè¯æž„å»ºäº§ç‰©
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "dist/taskpane.html" ]; then
            echo "âŒ taskpane.html ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… æž„å»ºéªŒè¯é€šè¿‡"
