name: Quick Build - å¿«é€Ÿæž„å»º

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'é€‰æ‹©æž„å»ºå¹³å°'
        required: true
        type: choice
        options:
          - 'all'
          - 'office-addin'
          - 'electron-windows'
          - 'electron-mac'
          - 'electron-linux'
      upload_artifacts:
        description: 'ä¸Šä¼ æž„å»ºäº§ç‰©'
        required: false
        type: boolean
        default: true

jobs:
  build-office-addin:
    name: å¿«é€Ÿæž„å»º - Office åŠ è½½é¡¹
    runs-on: ubuntu-latest
    if: inputs.platform == 'all' || inputs.platform == 'office-addin'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æž„å»º
        run: npm run build
      
      - name: æ‰“åŒ…
        run: |
          mkdir -p release
          cd dist
          zip -r ../release/MSWordAutoComplete-Office-Addin.zip .
          cd ..
          cp manifest.xml release/
      
      - name: ç”Ÿæˆå®‰è£…è„šæœ¬
        run: node scripts/create-installers.js || echo "å®‰è£…è„šæœ¬ç”Ÿæˆå¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
      
      - name: ä¸Šä¼ äº§ç‰©
        if: inputs.upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: office-addin-quick-build
          path: release/
          retention-days: 3
      
      - name: æž„å»ºæ‘˜è¦
        run: |
          echo "## âœ… Office åŠ è½½é¡¹æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **æž„å»ºäº§ç‰©ï¼š**" >> $GITHUB_STEP_SUMMARY
          ls -lh release/ >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¾ **æ€»å¤§å°ï¼š** $(du -sh release/ | cut -f1)" >> $GITHUB_STEP_SUMMARY

  build-electron-windows:
    name: å¿«é€Ÿæž„å»º - Electron Windows
    runs-on: windows-latest
    if: inputs.platform == 'all' || inputs.platform == 'electron-windows'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æž„å»º
        run: npm run build
      
      - name: æž„å»º Electron
        run: npm run electron:build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ä¸Šä¼ äº§ç‰©
        if: inputs.upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-windows-quick-build
          path: release/*.exe
          retention-days: 3
      
      - name: æž„å»ºæ‘˜è¦
        run: |
          echo "## âœ… Electron Windows æž„å»ºå®Œæˆ" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **æž„å»ºäº§ç‰©ï¼š**" >> $env:GITHUB_STEP_SUMMARY
          Get-ChildItem release/*.exe | Format-Table Name, Length >> $env:GITHUB_STEP_SUMMARY
        shell: pwsh

  build-electron-mac:
    name: å¿«é€Ÿæž„å»º - Electron Mac
    runs-on: macos-latest
    if: inputs.platform == 'all' || inputs.platform == 'electron-mac'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æž„å»º
        run: npm run build
      
      - name: æž„å»º Electron
        run: npm run electron:build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: ä¸Šä¼ äº§ç‰©
        if: inputs.upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-mac-quick-build
          path: release/*.dmg
          retention-days: 3
      
      - name: æž„å»ºæ‘˜è¦
        run: |
          echo "## âœ… Electron Mac æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **æž„å»ºäº§ç‰©ï¼š**" >> $GITHUB_STEP_SUMMARY
          ls -lh release/*.dmg >> $GITHUB_STEP_SUMMARY

  build-electron-linux:
    name: å¿«é€Ÿæž„å»º - Electron Linux
    runs-on: ubuntu-latest
    if: inputs.platform == 'all' || inputs.platform == 'electron-linux'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æž„å»º
        run: npm run build
      
      - name: æž„å»º Electron
        run: npm run electron:build:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ä¸Šä¼ äº§ç‰©
        if: inputs.upload_artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-linux-quick-build
          path: release/*.AppImage
          retention-days: 3
      
      - name: æž„å»ºæ‘˜è¦
        run: |
          echo "## âœ… Electron Linux æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **æž„å»ºäº§ç‰©ï¼š**" >> $GITHUB_STEP_SUMMARY
          ls -lh release/*.AppImage >> $GITHUB_STEP_SUMMARY

  build-summary:
    name: æž„å»ºæ€»ç»“
    needs: [build-office-addin, build-electron-windows, build-electron-mac, build-electron-linux]
    runs-on: ubuntu-latest
    if: always() && inputs.upload_artifacts
    
    steps:
      - name: ç”Ÿæˆæ€»ç»“
        run: |
          echo "# ðŸŽ‰ å¿«é€Ÿæž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å·²å®Œæˆæ‰€é€‰å¹³å°çš„æž„å»ºï¼Œè¯·ä»Ž Actions æ ‡ç­¾é¡µä¸‹è½½æž„å»ºäº§ç‰©ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ä¸‹è½½è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ç‚¹å‡»ä¸Šæ–¹çš„ 'Artifacts' æŸ¥çœ‹æ‰€æœ‰æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "2. ç‚¹å‡»ç›¸åº”çš„äº§ç‰©åç§°è¿›è¡Œä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "3. æž„å»ºäº§ç‰©å°†ä¿ç•™ 3 å¤©" >> $GITHUB_STEP_SUMMARY
